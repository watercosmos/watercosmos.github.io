---
title: RFC 1928&#58; SOCKS5 协议 (译)
---



本文全文翻译自 RFC 1928 备忘录.

原文: <https://www.ietf.org/rfc/rfc1928.txt>


Network Working Group<br />
Request for Comments: 1928<br />
Category: Standards Track


备忘录状态
----------

本文为互联网社区描述了一份标准化协议, 需进一步的讨论和改进建议. 请参阅最新版本的 "[Internet Official Protocol Standards][1]" (STD 1) 获取本协议的标准化状态. 本备忘录的分发无限制.

[1]: http://www.rfc-editor.org/search/standards.php


致谢
----

本备忘录描述了 [SOCKS4 协议][2] \[1\] 的一个演进版. 新的协议来源于积极的讨论与原型实现. 主要贡献者有: Marcus Leech: 贝尔-北方研究中心, David Koblas: 独立顾问, Ying-Da Lee: NEC 系统实验室, LaMont Jones: 惠普, Ron Kuris: 统一通信, Matt Ganis: IBM.

\[译者注\]: 请参阅我的上一篇博客: [<SOCKS4: 用于穿透防火墙的TCP代理协议 (译)>][3].

[2]: http://ftp.icm.edu.pl/packages/socks/socks4/SOCKS4.protocol
[3]: http://lhy.im/socks4-protocol


1\. 介绍
--------

利用网络防火墙, 系统可以有效的将机构内部网络从 INTERNET 等外部网络隔离出来, 这种做法越来越普及. 这些防火墙系统往往在网络间充当应用层网关, 通常提供 TELNET, FTP 和 SMTP 等协议的访问控制服务. 为促进全球信息发现, 越来越多的尖端应用层协议被设计出来, 为所有这些协议提供一个通用的框架来完成透明且安全的防火墙穿透成为需求.

同时, 存在一种需求对这种穿越进行可行的精细化强认证. 该要求来源于不同机构网络间出现的客户端 - 服务器关系, 这种关系需要被控制并常常需要经过强健的认证.

本协议被设计用于为客户端 - 服务器架构应用程序提供一个框架, 使 TCP 和 UDP 连接可以方便而安全的使用网络防火墙服务. 本协议在概念上处于应用层与传输层之间的垫片层, 因此不提供网络层网关服务, 如 ICMP 报文转发.


2\. 现存实现
------------

当前存在的协议版本为 4, 它为基于 TCP 的客户端 - 服务器架构应用提供无保障的防火墙穿越服务, 支持 TELNET, FTP 及众多流行的信息发现协议, 如 HTTP, WAIS 和 GOPHER.

新的协议扩展了 SOCKS4 模型和框架, 使之支持 UDP 连接和通行的强身份验证方案, 并扩展了寻址方案使之支持域名和 IPV6 地址.

SOCKS 协议的实现通常涉及 TCP 客户端应用的重编译或重链接, 以使用 SOCKS 库中的适当封装例程.

### 注:

除非另有说明, 十进制数字在包格式图中代表对应字段的字节长度. 当给定字节需要接受一个特定值, 则使用 X'hh' 句法来表示该字段的单字节值. 单词 "Variable" 代表对应字段长度可变, 这取决于其相关的长度字段或数据类型字段.


3\. TCP 客户端流程
------------------

当一个 TCP 客户端需要与一个必须经过防火墙的对象建立连接时 (该决定取决于具体实现), 它必须与 SOCKS 服务器上的适当端口建立 TCP 连接. 传统上 SOCKS 服务器使用 1080 端口. 当连接请求成功后, 客户端进入所采用认证方法的协商阶段, 使用所选方法完成认证, 然后发送一个中继请求. SOCKS 服务器评估该请求后建立适当连接或拒绝请求.

首先客户端连接到服务器, 并发送一个包含版本标识符和方法选择信息的消息:

        +----+----------+----------+
        |VER | NMETHODS | METHODS  |
        +----+----------+----------+
        | 1  |    1     | 1 to 255 |
        +----+----------+----------+

VER 字段置为 X'05', 代表协议版本. NMETHODS 字段代表认证方法标识符字段 METHODS 的字节数.

服务器从 METHODS 字段提供的方法中选择一种, 并发送一个 METHOD 选择信息:

        +----+--------+
        |VER | METHOD |
        +----+--------+
        | 1  |   1    |
        +----+--------+

若选择的 METHOD 是 X'FF', 则客户端列出的所有方法均不接受, 客户端*必须*关闭连接.

当前为 METHOD 字段定义的值如下:

-   X'00'          无需认证
-   X'01'          GSSAPI
-   X'02'          用户名/密码
-   X'03' - X'7F'  IANA ASSIGNED
-   X'80' - X'FE'  保留的私有方法
-   X'FF'          无可接受方法

之后客户端与服务器进入指定认证方法的协商阶段. 对于不同方法的协商过程描述请参看其他协议文档.

支持本协议的新 METHOD 开发者需联系 IANA 获得 METHOD 号. 可参考已分配号文档以获得当前 METHOD 号与对应协议的列表.

兼容的实现*必须*支持 GSSAPI 并*应该*支持用户名/密码认证方法.


4\. 请求
--------

一旦指定认证方法的协商过程完成, 客户端发送详细的请求信息. 若协商方法中规定需要为完整性校验和/或保密性等目的而对数据进行封装, 则请求信息*必须*按协商方法指定的方式进行封装.

SOCKS 请求格式如下:

        +----+-----+-------+------+----------+----------+
        |VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
        +----+-----+-------+------+----------+----------+
        | 1  |  1  | X'00' |  1   | Variable |    2     |
        +----+-----+-------+------+----------+----------+

其中:

-   VER  协议版本:     X'05'
-   CMD
    -   CONNECT        X'01'
    -   BIND           X'02
    -   UDP ASSOCIATE  X'03'
-   RSV   保留
-   ATYP  地址类型
    -   IP V4 地址:    X'01'
    -   DOMAINNAME:    X'03'
    -   IP V6 地址:    X'04'
-   DST.ADDR  所需目的地址
-   DST.PORT  所需目的端口号, 以网络字节顺序出现

SOCKS 服务器通常根据源地址和目的地址来评估请求, 然后返回一个或多个与请求类型对应的回复消息.


5\. 寻址
--------

对于地址域 (DST.ADDR, BND.ADDR), ATYP 字段指定了地址类型, 例如:

-   X'01'

代表 IPV4 地址, 长度 4 字节.

-   X'03'

代表地址域是规范的域名. 地址域的第一字节为接下来域名的字节长度, 无 NUL 结束字节.

-   X'04'

代表 IPV6 地址, 长度 16 字节.


6\. 回复
--------

一旦客户端与 SOCKS 服务器建立连接并完成协商阶段, 立即发送请求信息. 服务器评估请求, 并返回以下格式的回复信息:

        +----+-----+-------+------+----------+----------+
        |VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
        +----+-----+-------+------+----------+----------+
        | 1  |  1  | X'00' |  1   | Variable |    2     |
        +----+-----+-------+------+----------+----------+

其中:

-   VER  协议版本:  X'05'
-   REP  回复域:
    -   X'00'          成功
    -   X'01'          常规服务器错误
    -   X'02'          规则禁止连接
    -   X'03'          网络无法访问
    -   X'04'          主机不可达
    -   X'05'          连接被拒绝
    -   X'06'          TTL 超时
    -   X'07'          命令不支持
    -   X'08'          地址类型不支持
    -   X'09' - X'FF'  未分配
-   RSV   保留
-   ATYP  地址类型
    -   IPV4 地址:  X'01'
    -   域名:       X'03'
    -   IPV6 地址:  X'04'
-   BND.ADDR  服务器绑定地址
-   BND.PORT  服务器绑定端口号, 以网络字节顺序出现

保留域 RESERVED (RSV) 必须置为 X'00'.

若选择的方法中规定需要为认证, 完整性和/或保密性等目的而对数据进行封装, 则回复包使用指定方法进行封装.

### CONNECT

在 CONNECT 操作的回复包中, BND.PORT 为服务器用于连接目标主机的端口号, BND.ADDR 为关联的 IP 地址. 由于服务器通常是多宿主主机, 因此 BND.ADDR 通常不是客户端用于连接到 SOCKS 服务器的 IP 地址. SOCKS 服务器将使用 DST.ADDR, DST.PORT, 客户端的源地址和端口号来评估 CONNECT 请求是否通过.

### BIND

BIND 请求用于客户端需要接收服务器的传入连接的协议. FTP 是一个众所周知的例子, 它使用客户端到服务器的主连接发送命令和状态报告, 并根据请求, 使用服务器到客户端的连接来传输数据 (如 LS, GET, PUT).

应用协议的客户端一侧只有在使用 CONNECT 操作建立了与 SOCKS 服务器的主连接后才能使用 BIND 请求来建立次连接. SOCKS 服务器将使用 DST.ADDR 和 DST.PORT 域来评估 BIND 请求.

BIND 操作过程中, SOCKS 服务器将发送两个回复包给客户端. 第一个回复包在服务器建立并绑定一个新的 socket 后发送. BND.PORT 域指明 SOCKS 服务器分配用于监听传入连接的端口号. BND.ADDR 域指明关联的 IP 地址. 客户端通常将这些信息告知应用服务器 (通过主连接或控制连接), 约定以此地址作为客户端的接收地址. 第二个回复包在预期的传入连接成功建立或失败后发送.

在第二个回复包中, BND.PORT 域和 BND.ADDR 域指明所连接的主机的地址和端口号.

### UDP ASSOCIATE

UDP ASSOCIATE 请求用于与 UDP 中继进程建立关联 (association) 来处理 UDP 数据报. DST.ADDR 域和 DST.PORT 域指明客户端用于发送 UDP 数据报给这一关联 (association) 的客户端本地地址和端口号. 服务器*可以*使用这一信息来限制访问这个关联. 若在这一次 UDP 关联中客户端不是信息的独占者, 则*必须*将地址与端口号全部置 0.

当用于传输 UDP ASSOCIATE 请求的 TCP 连接断开时, UDP 关联即终止.

在 UDP ASSOCIATE 请求的回复包中, BND.PORT 域和 BND.ADDR 域表示客户端*必须*发送 UDP 请求消息给这一地址和端口号以获得中继.

### 回复处理

当一个回复包表示请求失败时 (REP 的值非 X'00'), SOCKS 服务器*必须*在发送回复包后立即中断 TCP 连接. 这一过程在检测到失败后的 10 秒内完成.

当回复码指示请求成功 (REP 的值为 X'00'), 并且请求的是 BIND 或 CONNECT 操作, 客户端可以立即开始传输数据. 若认证方法支持为完整性, 可验证和/或保密性等目的而对数据进行封装, 则数据将使用指定的方法进行封装. 同样, 当交给客户端的数据到达 SOCKS 服务器, 服务器*必须*使用认证方法的规定对数据进行封装.


7\. UDP 客户端流程
--------------------

基于 UDP 的客户端*必须*将数据报发送给 UDP 中继服务器的 UDP 端口, 该端口由 UDP ASSOCIATE 请求的回复包中的 BND.PORT 域获知. 若所选认证方法需要对数据进行封装, 则数据报*必须*用合适的方法进行封装. 每一个 UDP 数据报携带一个 UDP 请求头部:

        +----+------+------+----------+----------+----------+
        |RSV | FRAG | ATYP | DST.ADDR | DST.PORT |   DATA   |
        +----+------+------+----------+----------+----------+
        | 2  |  1   |  1   | Variable |    2     | Variable |
        +----+------+------+----------+----------+----------+

其中:

-   RSV             保留 X'0000'
-   FRAG            当前分段序号
-   ATYP            地址类型
    -   IPV4 地址:  X'01'
    -   域名:       X'03'
    -   IPV6 地址:  X'04'
-   DST.ADDR        所需目的地址
-   DST.PORT        所需目的端口号
-   DATA            用户数据

当 UDP 中继服务器决定中继一个 UDP 数据报, 它将静默执行, 而不会告知请求客户端. 同样, 当无法中继或不进行中继时, 将丢弃数据报. 当 UDP 中继服务器接收到远端主机的回复报文, 它*必须*使用上述的 UDP 请求头部和认证方法规定的封装方式对报文进行封装.

UDP 中继服务器*必须*从 SOCKS 服务器获得预期的客户端 IP 地址, 客户端使用该地址将数据报发送给 BND.PORT 端口, BND.PORT 由 UDP ASSOCIATE 的回复包中获得. UDP 中继服务器*必须*丢弃所有从非关联中记录的 IP 地址发来的数据报.

FRAG 域用于表示该数据报是否是一组分段包中的片段. 若执行分段, 则 FRAG 域最高位代表一组分段序列的最后一个片段, 若 FRAG 域的值为 X'00', 则代表该数据报独立未分段. 1 - 127 的取值范围表示当前数据报在一组分段序列中的位置. 每个接收者都拥有一个装配队列和一个装配定时器与分段数据关联. 当装配定时器超时, 或者一个 FRAG 域值比已处理的分段序列 FRAG 最大值要小的新数据报到达时, 装配队列必须重新初始化并且丢弃与之关联的分段. 推荐应用程序尽可能的避免使用分段.

分段的实现是可选的, 当一个实现不支持分段时, *必须*丢弃所有 FRAG 域值非 X'00' 的数据报.

支持 SOCKS 协议的 UDP 编程接口*必须*报告一个用于 UDP 数据报的缓存空间大小, 这个值必须比操作系统实际提供的缓存空间小:

-   若 ATYP 值为 X'01' - 根据认证方法不同, 比实际缓存空间小 10+ 字节
-   若 ATYP 值为 X'03' - 根据认证方法不同, 比实际缓存空间小 262+ 字节
-   若 ATYP 值为 X'04' - 根据认证方法不同, 比实际缓存空间小 20+ 字节


8\. 安全事项
------------

本文档描述了一个用于应用层穿越 IP 网络防火墙的协议. 这种穿越的安全性高度取决于特定实现所提供的, 并在 SOCKS 客户端与 SOCKS 服务器协商过程中选用的特定认证方式和封装方法.

对于认证方法的选择, 管理员应慎重考虑.


9\. 引用
--------

\[1\] Koblas, D., "SOCKS", Proceedings: 1992 Usenix Security Symposium.


作者联系方式
------------

Marcus Leech<br />
Bell-Northern Research Ltd<br />
P.O. Box 3511, Stn. C,<br />
Ottawa, ON<br />
CANADA K1Y 4H7<br />
<br />
Phone: (613) 763-9145<br />
EMail: mleech@bnr.ca
